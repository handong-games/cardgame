# 마을 시스템 (Village System)

> 지역 중간 지점(라운드 4)에서 장신구 획득 및 시설 이용

---

## 개요

| 항목 | 설명 |
|------|------|
| 진입 시점 | 라운드 4 (지역 중간 지점) |
| 마을 흐름 | 장신구 선택 → 시설 선택 → 행선지 선택 |
| 지역별 특성 | 각 지역마다 고유 장신구 및 시설 보유 |

---

## 마을 흐름

```
라운드 3 전투 완료
    ↓
보상 선택 (카드)
    ↓
행선지 선택 → 🏘️ 마을 선택
    ↓
┌─────────────────────────────────────┐
│  [1단계] 장신구 선택                 │
│  3개 중 1개 선택 (지역별 고정)        │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  [2단계] 시설 선택                   │
│  정령의 샘, 피의 제단 등 (지역별 상이) │
└─────────────────────────────────────┘
    ↓
행선지 선택 (라운드 5)
```

---

## 1. 장신구 시스템 (Accessory)

### 개요

| 항목 | 설명 |
|------|------|
| 정의 | 지속적인 패시브 효과를 주는 아이템 |
| 선택지 | 3개 (지역별 고정) |
| 보유 제한 | 무제한 |
| UI 위치 | 왼쪽 위 패널에 아이콘 표시 |

### 타입 정의

```typescript
interface Accessory {
  id: string;
  name: string;
  description: string;
  emoji: string;
  effect: AccessoryEffect;
}

interface AccessoryEffect {
  type: 'stat_boost' | 'on_turn_start' | 'on_card_play' | 'on_kill' | 'passive';
  // 효과별 상세 필드는 구현 시 확장
}
```

### 장신구 예시 (잊혀진 숲)

| 이름 | 이모지 | 효과 | 타입 |
|------|:------:|------|------|
| 이끼 낀 부적 | 🧿 | 턴 시작 시 방어력 +2 | on_turn_start |
| 숲의 가호 | 🌿 | 최대 HP +10 | stat_boost |
| 사냥꾼의 눈 | 👁️ | 공격 카드 데미지 +1 | passive |

### UI 레이아웃

```
┌─────────────────────────────────────────┐
│  마을에 도착했습니다                      │
│                                          │
│        장신구를 선택하세요                 │
│                                          │
│  ┌────────┐ ┌────────┐ ┌────────┐       │
│  │  🧿    │ │  🌿    │ │  👁️    │       │
│  │이끼 낀 │ │ 숲의   │ │사냥꾼의│       │
│  │ 부적   │ │ 가호   │ │  눈    │       │
│  │        │ │        │ │        │       │
│  │턴 시작 │ │최대 HP │ │공격 +1 │       │
│  │방어 +2 │ │  +10   │ │        │       │
│  └────────┘ └────────┘ └────────┘       │
└─────────────────────────────────────────┘
```

### 장신구 표시 UI (TopBar 좌측)

```
┌──────────────────────────────────────────────────┐
│ [🧿][🌿]  │  3/7 잊혀진 숲  │  💰 45           │
│ 장신구들   │  라운드 정보     │  골드            │
└──────────────────────────────────────────────────┘
```

---

## 2. 시설 시스템 (Facility)

### 개요

| 항목 | 설명 |
|------|------|
| 정의 | 마을에서 이용할 수 있는 서비스 |
| 표시 형태 | 시설 카드 (행선지 카드와 유사) |
| 지역별 차이 | 공통 시설 + 지역 전용 시설 |

### 시설 타입 정의

```typescript
type FacilityType = 'tavern' | 'blood_altar' | 'shop' | 'rest';

interface Facility {
  id: string;
  type: FacilityType;
  name: string;
  description: string;
  emoji: string;
  regionExclusive?: string;  // 특정 지역 전용일 경우
}
```

### 시설 목록

#### 공통 시설

| 시설 | 이모지 | 효과 |
|------|:------:|------|
| 정령의 샘 | 🌊 | 동료(정령) 3명 중 1명 선택 |

#### 잊혀진 숲 전용

| 시설 | 이모지 | 효과 |
|------|:------:|------|
| 피의 제단 | 🩸 | 즉시 보상 선택 + 남은 라운드 몬스터 강화 |

### 시설 선택 UI

```
┌─────────────────────────────────────────┐
│                                          │
│        🏠 시설 선택                       │
│                                          │
│  ┌────────┐  ┌────────┐  ┌────────┐     │
│  │  🌊    │  │  🩸    │  │  🚶    │     │
│  │정령의  │  │ 피의   │  │ 마을   │     │
│  │  샘    │  │ 제단   │  │떠나기  │     │
│  │        │  │        │  │        │     │
│  │정령과  │  │즉시보상│  │다음    │     │
│  │ 유대   │  │+강화   │  │행선지  │     │
│  └────────┘  └────────┘  └────────┘     │
│                                          │
└─────────────────────────────────────────┘
```

---

## 3. 동료 시스템 (Companion)

### 개요

| 항목 | 설명 |
|------|------|
| 획득 방법 | 정령의 샘에서 3명 중 1명 선택 |
| 효과 | 매 턴 자동으로 효과 수행 |
| 추가 보상 | 동료 연관 카드 1장 획득 |
| 보유 제한 | (미정) |

### 타입 정의

```typescript
interface Companion {
  id: string;
  name: string;
  description: string;
  emoji: string;
  turnEffect: CompanionEffect;  // 매 턴 자동 효과
  linkedCardId: string;         // 연관 카드 ID
}

interface CompanionEffect {
  type: 'damage' | 'heal' | 'block' | 'buff' | 'debuff';
  value: number;
  target: 'player' | 'enemy';
}
```

### 동료 예시 (잊혀진 숲)

| 이름 | 이모지 | 턴 효과 | 연관 카드 |
|------|:------:|---------|----------|
| 이끼 요정 | 🧚 | 턴 시작 시 HP +2 회복 | 자연의 축복 |
| 야생 늑대 | 🐺 | 턴 종료 시 적에게 3 데미지 | 연속 베기 |
| 숲 올빼미 | 🦉 | 턴 시작 시 카드 1장 드로우 | 행운의 주사위 |

### 동료 선택 UI (정령의 샘)

```
┌─────────────────────────────────────────┐
│                                          │
│     🌊 유대를 맺을 정령 선택              │
│                                          │
│  ┌────────┐ ┌────────┐ ┌────────┐       │
│  │  🧚    │ │  🐺    │ │  🦉    │       │
│  │ 이끼   │ │ 야생   │ │  숲    │       │
│  │ 요정   │ │ 늑대   │ │ 올빼미 │       │
│  │        │ │        │ │        │       │
│  │턴 시작 │ │턴 종료 │ │턴 시작 │       │
│  │HP +2   │ │3 데미지│ │드로우  │       │
│  │        │ │        │ │        │       │
│  │+연계   │ │+연계   │ │+연계   │       │
│  │카드    │ │카드    │ │카드    │       │
│  └────────┘ └────────┘ └────────┘       │
│                                          │
│        [ 동료 선택하기 ]  ← 선택 시 표시  │
│        [ ← 돌아가기 ]                    │
└─────────────────────────────────────────┘
```

#### 선택 UX 플로우

```
카드 클릭 → 선택됨 상태 (cyan 테두리 + ring 효과)
    ↓
"동료 선택하기" 버튼 등장
    ↓
버튼 클릭 → 카드가 캐릭터 방향으로 이동 애니메이션
    ↓
시설 선택 화면으로 복귀
```

### 동료 표시 UI

- **위치**: 플레이어 캐릭터 카드 **왼쪽**
- **크기**: CharacterCard와 동일 (w-48)
- **정렬**: 가로 중앙 정렬

```
┌──────────────────────────────────────┐
│                                      │
│  ┌────────┐  ┌────────┐             │
│  │  🧚    │  │  ⚔️    │             │
│  │ 이끼   │  │ 팔라딘 │ ← 캐릭터    │
│  │ 요정   │  │        │             │
│  │        │  │ HP 바  │             │
│  │턴 시작 │  │ 방어력 │             │
│  │HP +2   │  │        │             │
│  └────────┘  └────────┘             │
│   ↑ 동료                             │
│                                      │
└──────────────────────────────────────┘
```

---

## 4. 피의 제단 (Blood Altar)

### 개요

| 항목 | 설명 |
|------|------|
| 지역 | 잊혀진 숲 전용 |
| 선택 방식 | **계약 카드** 다중 선택 (0~3개) |
| 효과 | 선택한 계약만큼 보상 + 패널티 |
| 리스크/리워드 | 하이 리스크 하이 리턴, 히든 보상 |

### 계약 카드 시스템

피의 제단에서는 3개의 **계약 카드** 중 원하는 만큼 선택할 수 있습니다.
각 계약은 보상과 함께 고유한 패널티를 부여합니다.

| 계약 카드 | 이모지 | 보상 | 패널티 |
|----------|:------:|------|--------|
| 피의 재물 | 💰 | +80 골드 | HP -10 |
| 피의 힘 | ⚔️ | 최대 HP +10 | 저주 카드 획득 + 몬스터 공격력 +25% |
| 피의 유물 | 💎 | 피의 유물 장신구 | 몬스터 HP +20% |

### 히든 보상

| 조건 | 보상 | 연출 |
|------|------|------|
| 3개 계약 모두 선택 | **최대 에너지 +1** | 전체 화면 연출 (🔮 아이콘, 메시지) |

> "제단이 그대의 헌신에 응답한다..."

### 저주 카드 (피의 빚)

피의 힘 계약 선택 시 덱에 추가되는 저주 카드입니다.

| 이름 | 코스트 | 효과 |
|------|:------:|------|
| 피의 빚 | 0 | 소멸, HP -3 (사용/버려야 제거) |

### 타입 정의

```typescript
interface BloodAltarReward {
  id: string;
  type: 'gold' | 'maxHp' | 'accessory';
  name: string;
  description: string;
  emoji: string;
  // 보상
  goldReward?: number;
  maxHpReward?: number;
  accessoryId?: string;
  // 패널티
  penalty: {
    hpCost?: number;
    curseCard?: boolean;
    monsterAttackBuff?: number;  // 비율 (예: 0.25 = 25%)
    monsterHpBuff?: number;      // 비율 (예: 0.2 = 20%)
  };
}

interface BloodAltarState {
  selectedRewards: string[];     // 선택한 계약 ID 목록
  monsterAttackBuff: number;     // 누적 공격력 강화 비율
  monsterHpBuff: number;         // 누적 HP 강화 비율
}
```

### UI 레이아웃

```
┌─────────────────────────────────────────┐
│  🩸 피의 제단                            │
│  "피로 계약을 맺어라"                     │
│                                          │
│  ⚠️ 선택한 계약만큼 대가를 치른다         │
│                                          │
│  ┌────────┐ ┌────────┐ ┌────────┐       │
│  │  💰    │ │  ⚔️    │ │  💎    │       │
│  │ 피의   │ │ 피의   │ │ 피의   │       │
│  │ 재물   │ │  힘    │ │ 유물   │       │
│  │        │ │        │ │        │       │
│  │"부를   │ │"강해지 │ │"힘을   │       │
│  │갈망하는│ │길 원하 │ │빌리고  │       │
│  │가?"    │ │는가?"  │ │싶은가?"│       │
│  └────────┘ └────────┘ └────────┘       │
│                                          │
│        1개 선택됨 / 3개                   │
│                                          │
│        [ 제단에 바친다 ]  ← 텍스트 떨림   │
│        [ ← 돌아가기 ]                    │
└─────────────────────────────────────────┘
```

### UI/UX 상세

#### 계약 카드 효과
- **호버 시**: 획득 아이템 미리보기 (저주 카드, 장신구)
- **속삭임 애니메이션**: 설명 텍스트에 불투명도 펄스 + 빨간 글로우 + 미세한 떨림
- **선택 시**: 속삭임 애니메이션 지속

#### 버튼 애니메이션
- **"제단에 바친다" 버튼**: 선택된 계약 수에 따라 텍스트 떨림 강도 증가
  - 1개: 약한 떨림
  - 2개: 중간 떨림
  - 3개: 강한 떨림 (빠른 주기)

#### 순차 등장 애니메이션
1. 타이틀 (0s)
2. 부제목 (0.3s)
3. 계약 카드 (1.0s)
4. 선택 정보 (1.3s)
5. 버튼 (1.5s)

---

## 5. 게임 상태 확장

### RunState 확장

```typescript
interface RunState {
  regionId: string;
  round: number;
  totalRounds: number;
  isComplete: boolean;
  selectedDestinationType?: DestinationType;

  // 마을 시스템 추가
  accessories: Accessory[];           // 획득한 장신구 목록
  companions: Companion[];            // 동료 목록
  bloodAltarActivated: boolean;       // 피의 제단 활성화 여부
  monsterBuffPercent: number;         // 몬스터 강화 비율
}
```

### BattlePhase 확장

```typescript
type BattlePhase =
  | 'player_turn'
  | 'enemy_turn'
  | 'victory'
  | 'defeat'
  | 'reward_selection'
  | 'destination_selection'
  // 마을 시스템 추가
  | 'village_accessory'     // 장신구 선택
  | 'village_facility'      // 시설 선택
  | 'tavern_companion'      // 정령의 샘 - 동료 선택
  | 'blood_altar_reward';   // 피의 제단 - 보상 선택
```

---

## 6. 관련 파일

| 파일 | 역할 | 상태 |
|------|------|:----:|
| `types/index.ts` | Accessory, Companion, Facility 타입 | ✅ |
| `data/accessories.ts` | 장신구 데이터 | ✅ |
| `data/companions.ts` | 동료 데이터 | ✅ |
| `data/facilities.ts` | 시설 데이터 | ✅ |
| `data/cards/common.ts` | 동료 연계 카드 정의 | ✅ |
| `stores/gameStore.ts` | 마을 관련 상태 및 액션 | ✅ |
| `components/screens/BattleScreen.tsx` | 마을 UI (팝업/인라인) | ✅ |
| `components/ui/AccessoryPanel.tsx` | 장신구 표시 UI | ⏳ |

---

## 7. 구현 현황

| 순위 | 항목 | 설명 | 상태 |
|:----:|------|------|:----:|
| 1 | 마을 진입 흐름 | 라운드 4 자동 진입 + 진입 연출 | ✅ |
| 2 | 장신구 시스템 | 선택 UI (팝업) + stat_boost 효과 적용 | ✅ |
| 3 | 시설 선택 UI | 시설 카드 표시 (지역명 타이틀) | ✅ |
| 4 | 정령의 샘 (동료) | 동료 선택 UI + 연계 카드 획득 + 동료 표시 | ✅ |
| 5 | 피의 제단 | 계약 카드 + 히든 보상 + 몬스터 강화 | ✅ |
| 6 | 장신구 표시 UI | TopBar 좌측 아이콘 패널 + 툴팁 | ✅ |
| 7 | 동료 턴 효과 | 전투 중 자동 효과 발동 | ⏳ |

---

## 8. 동료 연계 카드 (구현 완료)

| 동료 | 연계 카드 | 코스트 | 효과 |
|------|----------|:------:|------|
| 이끼 요정 | 자연의 축복 | 1 | 6 방어, 에너지 1 회복 |
| 야생 늑대 | 연속 베기 | 1 | 5 데미지 x 2회 |
| 숲 올빼미 | 행운의 주사위 | 0 | 카드 2장 드로우 |

---

## 미결정 사항

- [x] ~~장신구 상세 효과 목록~~ → 잊혀진 숲 3종 구현 완료
- [x] ~~동료 상세 능력치 및 연관 카드~~ → 3종 동료 + 연계 카드 구현 완료
- [x] ~~피의 제단 보상 밸런스~~ → 계약 카드 3종 + 히든 보상 구현 완료
- [ ] 동료 보유 제한 (현재 무제한)
- [ ] 추가 지역의 전용 시설
- [ ] 장신구 패시브 효과 전투 중 적용
- [ ] 동료 턴 효과 전투 중 적용
