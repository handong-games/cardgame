#!/bin/bash
# Git Pre-commit Hook: 문서 의존성 체크
# 변경된 문서의 연관 문서 업데이트 여부를 확인합니다.

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# 의존성 맵 파일 경로
DEPENDENCY_MAP=".claude/docs/dependency-map.md"

# 변경 로그 파일
CHANGELOG="01. docs/changelog.md"

# 스테이징된 .md 파일 목록 가져오기
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.md$')

# 새로 추가된 .md 파일 (Added only)
NEW_MD_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.md$')

# 삭제된 .md 파일 (Deleted only)
DELETED_MD_FILES=$(git diff --cached --name-only --diff-filter=D | grep '\.md$')

# docs-mapping 파일 경로
DOCS_MAPPING=".claude/agents/docs-mapping.md"

# .md 파일이 없으면 종료 (삭제 파일도 체크)
if [ -z "$STAGED_FILES" ] && [ -z "$DELETED_MD_FILES" ]; then
    exit 0
fi

# 의존성 맵이 없으면 경고 후 종료
if [ ! -f "$DEPENDENCY_MAP" ]; then
    echo -e "${YELLOW}[경고] 의존성 맵 파일이 없습니다: $DEPENDENCY_MAP${NC}"
    exit 0
fi

# 연관 문서 찾기 함수
find_related_docs() {
    local file="$1"
    local basename=$(basename "$file")

    # dependency-map.md에서 해당 파일의 연관 문서 추출
    # 형식: | `파일명` | 연관문서1, 연관문서2 | 비고 |
    local line=$(grep "| \`$basename\`" "$DEPENDENCY_MAP" 2>/dev/null)

    if [ -n "$line" ]; then
        # 두 번째 컬럼 (연관 문서) 추출
        echo "$line" | awk -F'|' '{print $3}' | tr ',' '\n' | sed 's/^ *//;s/ *$//' | grep -v '^$'
    fi
}

# 경고 메시지 수집
MISSING_RELATED=()
CHANGELOG_MISSING=false

echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}  문서 의존성 체크 (pre-commit hook)${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""

# 새 문서 등록 여부 체크
NEW_DOC_WARNINGS=false

if [ -n "$NEW_MD_FILES" ]; then
    echo -e "${CYAN}[새 문서 감지]${NC}"

    echo "$NEW_MD_FILES" | while IFS= read -r file; do
        # 빈 줄 스킵
        if [ -z "$file" ]; then
            continue
        fi

        file_basename=$(basename "$file")

        # changelog.md, dependency-map.md, docs-mapping.md는 스킵
        if [[ "$file_basename" == "changelog.md" ]] || \
           [[ "$file_basename" == "dependency-map.md" ]] || \
           [[ "$file_basename" == "docs-mapping.md" ]]; then
            continue
        fi

        # dependency-map 등록 여부 체크
        if ! grep -q "\`$file_basename\`" "$DEPENDENCY_MAP" 2>/dev/null; then
            echo -e "  ${YELLOW}[미등록]${NC} $file_basename → dependency-map.md 추가 필요"
            # 서브쉘 내에서 변수 수정은 외부에 영향 없음, 파일로 플래그 저장
            touch /tmp/new_doc_warning_flag
        else
            echo -e "  ${GREEN}[등록됨]${NC} $file_basename (dependency-map)"
        fi

        # docs-mapping 등록 여부 체크
        if [ -f "$DOCS_MAPPING" ]; then
            if ! grep -q "$file_basename" "$DOCS_MAPPING" 2>/dev/null; then
                echo -e "  ${YELLOW}[미등록]${NC} $file_basename → docs-mapping.md 추가 필요"
                touch /tmp/new_doc_warning_flag
            else
                echo -e "  ${GREEN}[등록됨]${NC} $file_basename (docs-mapping)"
            fi
        fi
    done

    # 플래그 파일 확인
    if [ -f /tmp/new_doc_warning_flag ]; then
        NEW_DOC_WARNINGS=true
        rm -f /tmp/new_doc_warning_flag
    fi
    echo ""
fi

# 삭제된 문서 체크
DELETED_DOC_WARNINGS=false

if [ -n "$DELETED_MD_FILES" ]; then
    echo -e "${RED}[삭제된 문서 감지]${NC}"

    echo "$DELETED_MD_FILES" | while IFS= read -r file; do
        # 빈 줄 스킵
        if [ -z "$file" ]; then
            continue
        fi

        file_basename=$(basename "$file")

        echo -e "  ${RED}[삭제]${NC} $file_basename"

        # dependency-map에 등록되어 있는지 체크
        if grep -q "\`$file_basename\`" "$DEPENDENCY_MAP" 2>/dev/null; then
            echo -e "    ${YELLOW}→ dependency-map.md에서 제거 필요${NC}"
            touch /tmp/deleted_doc_warning_flag
        fi

        # docs-mapping에 등록되어 있는지 체크
        if [ -f "$DOCS_MAPPING" ]; then
            if grep -q "$file_basename" "$DOCS_MAPPING" 2>/dev/null; then
                echo -e "    ${YELLOW}→ docs-mapping.md에서 제거 필요${NC}"
                touch /tmp/deleted_doc_warning_flag
            fi
        fi

        # 다른 문서에서 이 파일을 참조하는지 체크 (dependency-map의 연관 문서 컬럼)
        refs=$(grep "$file_basename" "$DEPENDENCY_MAP" 2>/dev/null | grep -v "| \`$file_basename\`" | head -3)
        if [ -n "$refs" ]; then
            echo -e "    ${YELLOW}→ 다른 문서가 이 파일을 참조 중${NC}"
            touch /tmp/deleted_doc_warning_flag
        fi
    done

    # 플래그 파일 확인
    if [ -f /tmp/deleted_doc_warning_flag ]; then
        DELETED_DOC_WARNINGS=true
        rm -f /tmp/deleted_doc_warning_flag
    fi
    echo ""
fi

# 각 변경된 파일에 대해 연관 문서 확인
for file in $STAGED_FILES; do
    # 경로에서 파일명만 추출
    basename=$(basename "$file")

    # 자기 자신이 changelog.md인 경우 스킵
    if [[ "$basename" == "changelog.md" ]]; then
        continue
    fi

    # dependency-map.md 자체는 스킵
    if [[ "$basename" == "dependency-map.md" ]]; then
        continue
    fi

    # 연관 문서 찾기
    RELATED=$(find_related_docs "$file")

    if [ -n "$RELATED" ]; then
        echo -e "${GREEN}[변경됨]${NC} $basename"
        echo -e "  연관 문서:"

        while IFS= read -r related; do
            # 공백 제거
            related=$(echo "$related" | xargs)

            # 빈 줄 스킵
            if [ -z "$related" ]; then
                continue
            fi

            # 연관 문서가 스테이징에 포함되어 있는지 확인 (파일명으로 검색)
            if echo "$STAGED_FILES" | grep -q "$related"; then
                echo -e "    ${GREEN}[O]${NC} $related"
            else
                echo -e "    ${YELLOW}[ ]${NC} $related"
                MISSING_RELATED+=("$related (← $basename)")
            fi
        done <<< "$RELATED"
        echo ""
    fi
done

# changelog.md 체크
if ! echo "$STAGED_FILES" | grep -q "changelog.md"; then
    CHANGELOG_MISSING=true
fi

# 결과 출력
echo -e "${CYAN}----------------------------------------${NC}"

if [ ${#MISSING_RELATED[@]} -gt 0 ] || [ "$CHANGELOG_MISSING" = true ] || [ "$NEW_DOC_WARNINGS" = true ] || [ "$DELETED_DOC_WARNINGS" = true ]; then
    echo -e "${YELLOW}[주의] 문서 업데이트 필요:${NC}"
    echo ""

    if [ "$NEW_DOC_WARNINGS" = true ]; then
        echo -e "  ${YELLOW}새 문서 등록 필요:${NC}"
        echo -e "    - dependency-map.md 또는 docs-mapping.md 확인"
        echo ""
    fi

    if [ "$DELETED_DOC_WARNINGS" = true ]; then
        echo -e "  ${RED}삭제된 문서 정리 필요:${NC}"
        echo -e "    - dependency-map.md, docs-mapping.md에서 제거"
        echo -e "    - 참조하는 문서 링크 수정"
        echo ""
    fi

    if [ ${#MISSING_RELATED[@]} -gt 0 ]; then
        echo -e "  ${YELLOW}미변경 연관 문서:${NC}"
        for item in "${MISSING_RELATED[@]}"; do
            echo -e "    - $item"
        done
        echo ""
    fi

    if [ "$CHANGELOG_MISSING" = true ]; then
        echo -e "  ${RED}필수:${NC} changelog.md 업데이트 필요"
        echo ""
    fi

    echo -e "${CYAN}----------------------------------------${NC}"
    echo -e "${YELLOW}커밋을 계속하려면 --no-verify 옵션 사용${NC}"
    echo -e "  git commit --no-verify -m \"메시지\""
    echo -e "${CYAN}========================================${NC}"

    # 경고만 표시, 커밋은 허용 (exit 0)
    # 차단하려면 exit 1로 변경
    exit 0
else
    echo -e "${GREEN}[OK] 모든 연관 문서가 확인되었습니다.${NC}"
    echo -e "${CYAN}========================================${NC}"
    exit 0
fi
